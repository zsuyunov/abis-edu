const { PrismaClient } = require('@prisma/client');
const bcrypt = require('bcrypt');

const prisma = new PrismaClient();

// Student data
const studentsData = [
  {
    studentId: 'S48297',
    lastName: '–†–∞–∏–º–æ–≤–∞',
    firstName: '–ú–∞—Ö—Å—É–º–∞–±–µ–≥–∏–º –ö–∞–º–æ–ª–∏–¥–¥–∏–Ω –∫–∏–∑–∏',
    dateOfBirth: '2001-03-28',
    phone: '+998951515220',
    password: '–†–∞–∏–º–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S71581',
    lastName: '–ê–∑–∏–∑–æ–≤–∞',
    firstName: '–•–∞–±–∏–±–∞—Ö–æ–Ω –ê–±–¥—É–≤–æ—Ö–∏–¥ –∫–∏–∑–∏',
    dateOfBirth: '2001-03-29',
    phone: '+998951515221',
    password: '–ê–∑–∏–∑–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S24722',
    lastName: '–ê—à—É—Ä–æ–≤–∞',
    firstName: '–†–æ–±–∏—è –ó–∏—ë–¥—É–ª–ª–æ –∫–∏–∑–∏',
    dateOfBirth: '2001-03-30',
    phone: '+998951515222',
    password: '–ê—à—É—Ä–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S85955',
    lastName: '–ñ–∞–º–æ–ª–∏–¥–¥–∏–Ω–æ–≤–∞',
    firstName: '–û—Å–∏–µ –ö–∞–º–æ–ª–∏–¥–¥–∏–Ω–æ–≤–Ω–∞',
    dateOfBirth: '2001-03-31',
    phone: '+998951515223',
    password: '–ñ–∞–º–æ–ª–∏–¥–¥–∏–Ω–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S50416',
    lastName: '–ó–æ–∏—Ä–æ–≤–∞',
    firstName: '–ú—É—Ö—Å–∏–Ω–∞ –ë–∞—Ö—Ç–∏–µ—Ä –∫–∏–∑–∏',
    dateOfBirth: '2001-04-01',
    phone: '+998951515224',
    password: '–ó–æ–∏—Ä–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S17470',
    lastName: 'M—É—Ö—Ç–æ—Ä–æ–≤–∞',
    firstName: '–ó–∞–π–Ω–∞–± –û–¥–∏–ª–æ–≤–Ω–∞',
    dateOfBirth: '2001-04-02',
    phone: '+998951515225',
    password: 'M—É—Ö—Ç–æ—Ä–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S62937',
    lastName: '–†–∞—Ö–º–∞—Ç—É–ª–ª–∞–µ–≤–∞',
    firstName: '–°–∞—Ñ–∏—è –ö–∞—Ä–∏–º—É–ª–ª–æ –∫–∏–∑–∏',
    dateOfBirth: '2001-04-03',
    phone: '+998951515226',
    password: '–†–∞—Ö–º–∞—Ç—É–ª–ª–∞–µ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S39144',
    lastName: '–¢–æ–∏—Ä–æ–≤–∞',
    firstName: '–°–∞–º–∏–Ω–∞ –ñ–∞—Å—É—Ä –∫–∏–∑–∏',
    dateOfBirth: '2001-04-04',
    phone: '+998951515227',
    password: '–¢–æ–∏—Ä–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S56828',
    lastName: '–ù–µ–º–∞—Ç–∂–æ–Ω–æ–≤–∞',
    firstName: '–õ–æ–ª–∞ –†–∞–≤—à–∞–Ω –∫–∏–∑–∏',
    dateOfBirth: '2001-04-05',
    phone: '+998951515228',
    password: '–ù–µ–º–∞—Ç–∂–æ–Ω–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S48300',
    lastName: 'Islomjonova',
    firstName: 'Iymona Xurshidovna',
    dateOfBirth: '2001-04-06',
    phone: '+998951515229',
    password: 'Islomjonova_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S71584',
    lastName: '–ê–±–¥—É—Ä–∞—Ö–º–æ–Ω–æ–≤–∞',
    firstName: '–•–∞–¥–∏–∂–∞ –¢–µ–º—É—Ä–º–∞–ª–∏–∫ –∫–∏–∑–∏',
    dateOfBirth: '2001-04-07',
    phone: '+998951515230',
    password: '–ê–±–¥—É—Ä–∞—Ö–º–æ–Ω–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S24725',
    lastName: '–ê–∫–±–∞—Ä—Ö–æ–∂–∞–µ–≤–∞',
    firstName: '–ê—Ñ—Ä—É–∑–∞—Ö–æ–Ω –ê–ª–∏—à–µ—Ä—Ö–æ–∂–∞ –∫–∏–∑–∏',
    dateOfBirth: '2001-04-08',
    phone: '+998951515231',
    password: '–ê–∫–±–∞—Ä—Ö–æ–∂–∞–µ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S85958',
    lastName: '–ë–µ–∫–ø—É–ª–∞—Ç–æ–≤–∞',
    firstName: '–§–æ—Ç–∏–º–∞ –°–∞–Ω–∂–∞—Ä–±–µ–∫ –∫–∏–∑–∏',
    dateOfBirth: '2001-04-09',
    phone: '+998951515232',
    password: '–ë–µ–∫–ø—É–ª–∞—Ç–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S50419',
    lastName: '–ú–∏—Ä–∞–∫–±–∞—Ä–æ–≤–∞',
    firstName: '–•–∞–¥–∏–∂–∞ –ú–∏—Ä–æ–±–∏–¥ –∫–∏–∑–∏',
    dateOfBirth: '2001-04-10',
    phone: '+998951515233',
    password: '–ú–∏—Ä–∞–∫–±–∞—Ä–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S17473',
    lastName: '–ú–∏—Ä–∑–∞–±–µ–∫–æ–≤–∞',
    firstName: '–ú—É–±–∏–Ω–∞—Ö–æ–Ω –û—Ç–∞–±–µ–∫ –∫–∏–∑–∏',
    dateOfBirth: '2001-04-11',
    phone: '+998951515234',
    password: '–ú–∏—Ä–∑–∞–±–µ–∫–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S62940',
    lastName: '–ú—É—Ö–∞–º–º–µ–¥–æ–≤–∞',
    firstName: '–ú–∞–¥–∏–Ω–∞ –ù–æ–∑–∏–º –∫–∏–∑–∏',
    dateOfBirth: '2001-04-12',
    phone: '+998951515235',
    password: '–ú—É—Ö–∞–º–º–µ–¥–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S39147',
    lastName: '–†—É—Å—Ç–∞–º–æ–≤–∞',
    firstName: '–ò–º–æ–Ω–∞ –î–∞–≤—Ä–æ–Ω –∫–∏–∑–∏',
    dateOfBirth: '2001-04-13',
    phone: '+998951515236',
    password: '–†—É—Å—Ç–∞–º–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S56831',
    lastName: '–•—É–¥–∞–π–±–µ—Ä–≥–∞–Ω–æ–≤–∞',
    firstName: '–ê—Å–∏—è –î–∏–ª—à–æ–¥ –∫–∏–∑–∏',
    dateOfBirth: '2001-04-14',
    phone: '+998951515237',
    password: '–•—É–¥–∞–π–±–µ—Ä–≥–∞–Ω–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S48303',
    lastName: '–•—É—Å–∞–Ω–±–æ–µ–≤–∞',
    firstName: '–°–∞–±–∏–Ω–∞—Ö–æ–Ω –£–ª—É–≥–±–µ–∫ –∫–∏–∑–∏',
    dateOfBirth: '2001-04-15',
    phone: '+998951515238',
    password: '–•—É—Å–∞–Ω–±–æ–µ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S71587',
    lastName: '–ù–∞–∑–∞—Ä–æ–≤–∞',
    firstName: '–°–æ–ª–∏—Ö–∞ –†–∞—Ö–º–∞—Ç–∂–æ–Ω –∫–∏–∑–∏',
    dateOfBirth: '2001-04-16',
    phone: '+998951515239',
    password: '–ù–∞–∑–∞—Ä–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  },
  {
    studentId: 'S24728',
    lastName: '–ù–∞–∑–∞—Ä–æ–≤–∞',
    firstName: '–î—É—Ä–¥–æ–Ω–∞ –û–º–æ–Ω–∂–æ–Ω –∫–∏–∑–∏',
    dateOfBirth: '2001-04-17',
    phone: '+998951515240',
    password: '–ù–∞–∑–∞—Ä–æ–≤–∞_suzuk',
    gender: 'FEMALE',
    status: 'ACTIVE'
  }
];

// Function to generate unique student ID
async function generateUniqueStudentId(originalId) {
  let newId = originalId;
  let counter = 1;
  
  while (true) {
    const existing = await prisma.student.findUnique({
      where: { studentId: newId }
    });
    
    if (!existing) {
      return newId;
    }
    
    // Replace last 2 digits with counter (01, 02, 03, etc.)
    const baseId = originalId.substring(0, 3);
    newId = `${baseId}${counter.toString().padStart(2, '0')}`;
    counter++;
    
    if (counter > 99) {
      // If we can't find a unique ID, generate a completely random one
      const randomNum = Math.floor(Math.random() * 90000) + 10000;
      newId = `S${randomNum}`;
    }
  }
}

// Function to generate unique phone number
async function generateUniquePhone(originalPhone) {
  let newPhone = originalPhone;
  let counter = 1;
  
  while (true) {
    const existing = await prisma.student.findFirst({
      where: { phone: newPhone }
    });
    
    if (!existing) {
      return newPhone;
    }
    
    // Generate random Uzbek phone number
    const randomNum = Math.floor(Math.random() * 90000000) + 10000000;
    newPhone = `+9989${randomNum}`;
  }
}

async function main() {
  try {
    console.log('üå± Starting Year 5-"–ê"–ù–∞–¥–∂–∏–º–æ–≤–∞ –ì–∞–≤—Ö–∞—Ä –ú–∞–¥–∏—è—Ä–æ–≤–Ω–∞ class and students seeding...');

    // Find branch and academic year
    const branch = await prisma.branch.findFirst({
      where: { shortName: 'Suzuk' }
    });

    if (!branch) {
      throw new Error('Branch "Suzuk" not found');
    }
    console.log(`‚úÖ Found branch: ${branch.legalName} (ID: ${branch.id})`);

    const academicYear = await prisma.academicYear.findFirst({
      where: { name: '2025-2026' }
    });

    if (!academicYear) {
      throw new Error('Academic year "2025-2026" not found');
    }
    console.log(`‚úÖ Found academic year: ${academicYear.name} (ID: ${academicYear.id})`);

    // Create or find class
    const className = '5-"–ê"–ù–∞–¥–∂–∏–º–æ–≤–∞ –ì–∞–≤—Ö–∞—Ä –ú–∞–¥–∏—è—Ä–æ–≤–Ω–∞';
    let classRecord = await prisma.class.findFirst({
      where: {
        name: className,
        branchId: branch.id,
        academicYearId: academicYear.id
      }
    });

    if (!classRecord) {
      classRecord = await prisma.class.create({
        data: {
          name: className,
          branchId: branch.id,
          academicYearId: academicYear.id,
          capacity: studentsData.length,
          educationType: 'PRIMARY',
          language: 'UZBEK',
          status: 'ACTIVE'
        }
      });
      console.log(`‚úÖ Created class: ${className} (ID: ${classRecord.id})`);
    } else {
      console.log(`‚úÖ Found existing class: ${className} (ID: ${classRecord.id})`);
    }

    // Process students
    console.log(`üìö Processing ${studentsData.length} students...`);
    let createdCount = 0;
    let errorCount = 0;

    for (const studentData of studentsData) {
      try {
        // Generate unique student ID
        const uniqueStudentId = await generateUniqueStudentId(studentData.studentId);
        if (uniqueStudentId !== studentData.studentId) {
          console.log(`‚ö†Ô∏è  Student ID changed: ${studentData.studentId} ‚Üí ${uniqueStudentId}`);
        }

        // Generate unique phone number
        const uniquePhone = await generateUniquePhone(studentData.phone);
        if (uniquePhone !== studentData.phone) {
          console.log(`üì± Generated phone: ${uniquePhone} for ${studentData.firstName} ${studentData.lastName}`);
        }

        // Hash password
        const hashedPassword = await bcrypt.hash(studentData.password, 10);

        // Create student
        const student = await prisma.student.create({
          data: {
            id: `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            studentId: uniqueStudentId,
            lastName: studentData.lastName,
            firstName: studentData.firstName,
            dateOfBirth: new Date(studentData.dateOfBirth),
            phone: uniquePhone,
            password: hashedPassword,
            gender: studentData.gender,
            status: studentData.status,
            branchId: branch.id,
            classId: classRecord.id
          }
        });

        console.log(`‚úÖ Created student: ${student.firstName} ${student.lastName} (${student.studentId})`);
        createdCount++;

      } catch (error) {
        console.error(`‚ùå Error creating student ${studentData.firstName} ${studentData.lastName}:`, error.message);
        errorCount++;
      }
    }

    console.log(`\nüìä Summary:`);
    console.log(`‚úÖ Students created: ${createdCount}`);
    console.log(`‚ùå Errors: ${errorCount}`);
    console.log(`üìö Total processed: ${studentsData.length}`);

    if (errorCount === 0) {
      console.log('\nüéâ All students created successfully!');
    } else {
      console.log(`\n‚ö†Ô∏è  ${errorCount} students failed to create.`);
    }

  } catch (error) {
    console.error('‚ùå Error during seeding:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

main()
  .catch((error) => {
    console.error('‚ùå Seeding failed:', error);
    process.exit(1);
  });
